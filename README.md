# SAP: State-Aware Fuzzing with Practical Input Guidance for Smart Contract Vulnerability Detection

## HOW TO USE

Step 1: Get the training data from Etherscan, you can get the data by using the API provided by Etherscan.

For example using the `get_transaction` under `crawl` directory, you can get all the transactions by using `eth_getBlockByNumber` API.

And then using `get_input_with_contract` under `crawl` directory, you can get the raw transactions inputs and crawl bytecode and abi from Etherscan. The data will be saved as:

    {
        bytecode: xxxx,
        abi: xxx.
        inputs: xxx
    }

Step 2: Use the project [ethereum-input-decoder](https://github.com/miguelmota/ethereum-input-data-decoder) to decode the input. For example like the code in `metadata.js`, finally use the `getSample.py` to get the final processed function data and input data.

you can find the sample data like the following:

    "function": 
    {"types":["address[]", "uint256[]", "bytes[]"], 
    "method": "batchSend",
    "statevariable": "balance", 
    "graph": "FOR", 
    "param": "[]"}},
    {"inputs": [["500000000000000000"]],

    "function": {"types": ["uint256", "uint256[]"], 
    "method": "exitPool", 
    "statevariable": "", 
    "graph": "", 
    "param": "[]"}}, 
    {"inputs": [[{"type": "Buffer", "data": [61, 61, 192, 213, 50, 181, 75, 215, 182, 137, 24, 182, 184, 167, 86, 17]}, "7c1fcecb8cdad15b75dedd22079de1e7e334dd42", "a52e278c3fce80dbb5c2018950c505dbda204891", "1235760000000000000", "100", "28", {"type": "Buffer", "data": [211, 68, 88, 105, 106, 126, 111, 221, 137, 177, 113, 83, 206, 73, 9, 244, 254, 233, 20, 95, 141, 182, 1, 201, 70, 140, 166, 104, 176, 177, 184, 243]}, {"type": "Buffer", "data": [86, 93, 92, 117, 44, 9, 168, 11, 157, 184, 124, 69, 115, 245, 214, 230, 18, 255, 112, 197, 203, 162, 92, 214, 139, 154, 188, 207, 137, 180, 129, 116]}, "0"]]

Step 3: Now we get the sample data with all the functions and inputs we crawled. Then use the main program `SAPFuzzing.py `under `code` directory.  Before this you need to download the ALBERT model and use `albert-base-v2` to run the server, and then use `pip` download the relative library in the `environment.yml` under `FuzzingwithState` directory.


step 4: After generating transaction sequences following to the above steps, we need to use ContractFuzzer to test whether the generated transaction sequences can be successfully executed and uncover discoveries.  The `cfInstructions`in the main directory shows our instructions for deploying contract in the private chain and fuzzing contracts with transaction sequences generated by SAP and test these input with ContractFuzzer.  More details can refer to <https://github.com/gongbell/ContractFuzzer>

Datasets: since datasets used are too large to upload to GitHub, we upload all the datasets we used in our SAP to https://drive.google.com/drive/folders/1zgsjSECoW7m4o4l2-Q6y61IUeiXgOz65
